import { definePlugin } from '@devtools/core/plugins';
import { readFile, writeFile } from 'fs/promises';
import { join } from 'path';

const pluginName = '@devtools/builtin/package-readme';

const packageReadmePlugin = definePlugin<{
  // TODO: Define plugin options here
}>({
  name: pluginName,
  async setupPackage(pkg, { log }) {
    log.trace('Setting up package readme plugin', { pkg });

    const readmePath = join(pkg.dir, 'README.md');

    const sectionName = 'header';
    const insert = 'top';
    const notice = `Generated by ${pluginName}. Do not edit manually, instead run \`devtools prepare\`.`;
    const content = `# ${pkg.packageJson.name}

${pkg.packageJson.description ?? ''}
`.trim();

    // TODO: Return plop actions
    const commentPattern = { start: '<!--', end: '-->' };
    let currentContent = await readFile(readmePath, 'utf8').catch((error) =>
      error.code === 'ENOENT' ? '' : Promise.reject(error),
    );
    const markers = ['#region', '#endregion'].map(
      (marker) => `${commentPattern.start} ${marker} ${sectionName} ${commentPattern.end}`,
    );
    const regExp = new RegExp(markers.join('[^]*'), 'm');
    const replacement = [
      `${markers[0]}\n${commentPattern.start} ${notice} ${commentPattern.end}`,
      content.trim(),
      markers[1],
    ].join('\n\n');

    if (!currentContent.match(regExp)) {
      console.warn(`Section "${sectionName}" not found in ${readmePath}. Adding it.`);
      if (insert === 'top') {
        currentContent = [...markers, currentContent].join('\n\n');
      } else {
        currentContent = [currentContent, ...markers].join('\n\n');
      }
    }

    const result = `${currentContent.replace(regExp, replacement).trim()}\n`;

    await writeFile(readmePath, result, 'utf8');
  },
});

export default packageReadmePlugin;
